<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>西安大学生拼车平台</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'KaiTi', 'STKaiti', serif;
      background: linear-gradient(135deg, #f5f0e8 0%, #e8dcc8 100%);
      color: #2c1810;
      line-height: 1.8;
      padding: 20px;
    }

    .container {
      max-width: 900px;
      margin: 0 auto;
      background: rgba(255, 255, 255, 0.9);
      border-radius: 12px;
      box-shadow: 0 8px 32px rgba(44, 24, 16, 0.15);
      padding: 40px;
      border: 2px solid #c9a66b;
    }

    h1 {
      text-align: center;
      color: #8b4513;
      font-size: 2.5em;
      margin-bottom: 10px;
      font-weight: normal;
      letter-spacing: 4px;
      border-bottom: 3px double #c9a66b;
      padding-bottom: 20px;
    }

    .subtitle {
      text-align: center;
      color: #a0522d;
      font-size: 1.1em;
      margin-bottom: 30px;
      font-style: italic;
    }

    .notice {
      background: #fff8dc;
      border-left: 4px solid #daa520;
      padding: 15px 20px;
      margin-bottom: 30px;
      border-radius: 4px;
      font-size: 0.95em;
    }

    .notice-title {
      font-weight: bold;
      color: #8b4513;
      margin-bottom: 8px;
    }

    .form-group {
      margin-bottom: 20px;
    }

    label {
      display: block;
      margin-bottom: 8px;
      color: #5d4037;
      font-weight: 500;
    }

    input, select, textarea {
      width: 100%;
      padding: 12px;
      border: 1.5px solid #c9a66b;
      border-radius: 6px;
      font-size: 1em;
      font-family: inherit;
      background: #fefefe;
      transition: all 0.3s ease;
    }

    input:focus, select:focus, textarea:focus {
      outline: none;
      border-color: #8b4513;
      box-shadow: 0 0 8px rgba(139, 69, 19, 0.2);
    }

    /* 日期和时间选择器样式 */
    input[type="date"], input[type="time"] {
      color: #2c1810;
      cursor: pointer;
      font-family: 'KaiTi', 'STKaiti', serif;
    }

    /* 自定义日历图标样式 */
    input[type="date"]::-webkit-calendar-picker-indicator,
    input[type="time"]::-webkit-calendar-picker-indicator {
      cursor: pointer;
      opacity: 0.6;
      transition: opacity 0.3s ease;
      filter: sepia(80%) saturate(150%) hue-rotate(350deg) brightness(0.9);
    }

    input[type="date"]::-webkit-calendar-picker-indicator:hover,
    input[type="time"]::-webkit-calendar-picker-indicator:hover {
      opacity: 1;
    }

    /* 输入框内部样式 - 仅支持Webkit内核浏览器 */
    input[type="date"]::-webkit-datetime-edit,
    input[type="time"]::-webkit-datetime-edit {
      font-family: 'KaiTi', 'STKaiti', serif;
    }

    input[type="date"]::-webkit-datetime-edit-fields-wrapper,
    input[type="time"]::-webkit-datetime-edit-fields-wrapper {
      background: transparent;
    }

    input[type="date"]::-webkit-datetime-edit-text,
    input[type="time"]::-webkit-datetime-edit-text {
      color: #8b4513;
      padding: 0 0.3em;
    }

    input[type="date"]::-webkit-datetime-edit-month-field,
    input[type="date"]::-webkit-datetime-edit-day-field,
    input[type="date"]::-webkit-datetime-edit-year-field,
    input[type="time"]::-webkit-datetime-edit-hour-field,
    input[type="time"]::-webkit-datetime-edit-minute-field {
      color: #2c1810;
      background: transparent;
    }

    input[type="date"]::-webkit-datetime-edit-month-field:focus,
    input[type="date"]::-webkit-datetime-edit-day-field:focus,
    input[type="date"]::-webkit-datetime-edit-year-field:focus,
    input[type="time"]::-webkit-datetime-edit-hour-field:focus,
    input[type="time"]::-webkit-datetime-edit-minute-field:focus {
      background: #fff8dc;
      color: #8b4513;
      outline: none;
      border-radius: 3px;
    }

    /* Firefox日期选择器样式 */
    input[type="date"]::-moz-focus-inner,
    input[type="time"]::-moz-focus-inner {
      border: 0;
    }

    /* 自定义弹出日历样式 - 仅Webkit内核 */
    input[type="date"]::-webkit-calendar-picker-indicator {
      background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24"><path fill="%238b4513" d="M19 3h-1V1h-2v2H8V1H6v2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm0 16H5V8h14v11z"/></svg>');
      background-repeat: no-repeat;
      background-position: center;
      background-size: 18px;
      width: 20px;
      height: 20px;
    }

    input[type="time"]::-webkit-calendar-picker-indicator {
      background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24"><path fill="%238b4513" d="M12 2C6.5 2 2 6.5 2 12s4.5 10 10 10 10-4.5 10-10S17.5 2 12 2zm0 18c-4.4 0-8-3.6-8-8s3.6-8 8-8 8 3.6 8 8-3.6 8-8 8zm.5-13H11v6l5.2 3.2.8-1.3-4.5-2.7V7z"/></svg>');
      background-repeat: no-repeat;
      background-position: center;
      background-size: 18px;
      width: 20px;
      height: 20px;
    }

    .school-row {
      display: grid;
      grid-template-columns: 2fr 1fr;
      gap: 15px;
    }

    .datetime-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 15px;
    }

    button {
      width: 100%;
      padding: 14px;
      background: linear-gradient(135deg, #8b4513 0%, #a0522d 100%);
      color: white;
      border: none;
      border-radius: 6px;
      font-size: 1.1em;
      cursor: pointer;
      transition: all 0.3s ease;
      font-family: inherit;
      margin-top: 10px;
      letter-spacing: 2px;
    }

    button:hover {
      background: linear-gradient(135deg, #a0522d 0%, #8b4513 100%);
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(139, 69, 19, 0.3);
    }

    button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    .suggestions {
      position: absolute;
      background: white;
      border: 1.5px solid #c9a66b;
      border-radius: 6px;
      max-height: 200px;
      overflow-y: auto;
      width: calc(100% - 0px);
      z-index: 1000;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }

    .suggestion-item {
      padding: 12px;
      cursor: pointer;
      border-bottom: 1px solid #f0e6d2;
      transition: background 0.2s;
    }

    .suggestion-item:hover {
      background: #fff8dc;
    }

    .suggestion-item:last-child {
      border-bottom: none;
    }

    .matches {
      margin-top: 30px;
    }

    .match-card {
      background: #fffaf0;
      border: 1.5px solid #daa520;
      border-radius: 8px;
      padding: 20px;
      margin-bottom: 15px;
      transition: all 0.3s ease;
    }

    .match-card:hover {
      box-shadow: 0 4px 16px rgba(218, 165, 32, 0.2);
      transform: translateY(-2px);
    }

    .match-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
      padding-bottom: 10px;
      border-bottom: 1px solid #f0e6d2;
    }

    .match-name {
      font-size: 1.2em;
      font-weight: bold;
      color: #8b4513;
    }

    .match-distance {
      background: #daa520;
      color: white;
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 0.9em;
    }

    .match-info {
      line-height: 1.9;
      color: #5d4037;
    }

    .match-contact {
      margin-top: 12px;
      padding-top: 12px;
      border-top: 1px dashed #d4af37;
      color: #8b4513;
      font-weight: 500;
    }

    .donate-section {
      margin-top: 50px;
      padding: 30px;
      background: linear-gradient(135deg, #fffaf0 0%, #fff8dc 100%);
      border: 2px solid #c9a66b;
      border-radius: 12px;
    }

    .donate-title {
      text-align: center;
      color: #8b4513;
      font-size: 1.8em;
      margin-bottom: 20px;
      border-bottom: 2px solid #c9a66b;
      padding-bottom: 15px;
    }

    .donate-desc {
      color: #5d4037;
      margin-bottom: 25px;
      line-height: 2;
      text-align: center;
    }

    .qr-container {
      display: flex;
      justify-content: center;
      gap: 40px;
      margin-top: 20px;
      flex-wrap: wrap;
    }

    .qr-item {
      position: relative;
      text-align: center;
    }

    .qr-button {
      padding: 12px 30px;
      background: linear-gradient(135deg, #8b4513 0%, #a0522d 100%);
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 1.1em;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s ease;
      font-family: inherit;
      box-shadow: 0 2px 8px rgba(139, 69, 19, 0.2);
    }

    .qr-button:hover {
      background: linear-gradient(135deg, #a0522d 0%, #8b4513 100%);
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(139, 69, 19, 0.3);
    }

    .qr-popup {
      position: absolute;
      bottom: calc(100% + 15px);
      left: 50%;
      transform: translateX(-50%);
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s ease;
      z-index: 1000;
      pointer-events: none;
    }

    .qr-item:hover .qr-popup {
      opacity: 1;
      visibility: visible;
      bottom: calc(100% + 20px);
    }

    .qr-popup-inner {
      background: white;
      border: 2px solid #c9a66b;
      border-radius: 12px;
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.2);
      padding: 15px;
      position: relative;
    }

    .qr-popup-inner::after {
      content: '';
      position: absolute;
      bottom: -10px;
      left: 50%;
      transform: translateX(-50%);
      width: 0;
      height: 0;
      border-left: 10px solid transparent;
      border-right: 10px solid transparent;
      border-top: 10px solid #c9a66b;
    }

    .qr-popup-label {
      font-weight: bold;
      color: #8b4513;
      margin-bottom: 10px;
      font-size: 1em;
    }

    .qr-image-wrapper {
      width: 250px;
      height: 250px;
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
      background: white;
    }

    .qr-image {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
    }

    .footer {
      text-align: center;
      margin-top: 40px;
      padding-top: 25px;
      border-top: 2px solid #c9a66b;
      color: #8b4513;
      font-size: 0.9em;
    }

    .heart {
      color: #e74c3c;
      display: inline-block;
      animation: heartbeat 1.5s ease-in-out infinite;
    }

    @keyframes heartbeat {
      0%, 100% {
        transform: scale(1);
      }
      10%, 30% {
        transform: scale(1.1);
      }
      20%, 40% {
        transform: scale(1);
      }
    }

    .runtime {
      margin-top: 10px;
      color: #a0522d;
    }

    .stats {
      display: flex;
      justify-content: center;
      gap: 30px;
      margin-top: 15px;
      flex-wrap: wrap;
    }

    .stat-item {
      color: #a0522d;
    }

    .links {
      margin-top: 20px;
    }

    .links a {
      color: #8b4513;
      text-decoration: none;
      margin: 0 15px;
      transition: color 0.3s;
    }

    .links a:hover {
      color: #daa520;
      text-decoration: underline;
    }

    .loading {
      display: none;
      text-align: center;
      color: #8b4513;
      margin: 20px 0;
    }

    .error {
      background: #ffe4e1;
      border-left: 4px solid #dc143c;
      padding: 15px;
      margin: 15px 0;
      border-radius: 4px;
      color: #8b0000;
    }

    .success {
      background: #f0fff0;
      border-left: 4px solid #228b22;
      padding: 15px;
      margin: 15px 0;
      border-radius: 4px;
      color: #006400;
    }

    .tip {
      background: #e6f3ff;
      border-left: 4px solid #4682b4;
      padding: 12px 15px;
      margin: 15px 0;
      border-radius: 4px;
      font-size: 0.95em;
      color: #2c5282;
    }

    .tabs {
      display: flex;
      gap: 10px;
      margin-bottom: 25px;
      border-bottom: 2px solid #c9a66b;
    }

    .tab {
      padding: 12px 24px;
      background: transparent;
      border: none;
      border-bottom: 3px solid transparent;
      color: #8b4513;
      cursor: pointer;
      font-size: 1.05em;
      font-family: inherit;
      transition: all 0.3s ease;
      margin-bottom: -2px;
    }

    .tab:hover {
      background: rgba(139, 69, 19, 0.05);
    }

    .tab.active {
      border-bottom-color: #8b4513;
      font-weight: bold;
      color: #8b4513;
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
    }

    .query-result {
      margin-top: 20px;
      padding: 20px;
      background: #fffaf0;
      border: 1.5px solid #daa520;
      border-radius: 8px;
    }

    .stat-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin-top: 15px;
    }

    .stat-box {
      background: white;
      padding: 15px;
      border-radius: 6px;
      border: 1px solid #c9a66b;
      text-align: center;
    }

    .stat-box-value {
      font-size: 2em;
      font-weight: bold;
      color: #8b4513;
      margin-bottom: 5px;
    }

    .stat-box-label {
      color: #5d4037;
      font-size: 0.9em;
    }

    /* Giscus 评论框样式 */
    #comments {
      width: 100%;
      max-width: 100%;
      overflow: hidden;
    }

    #comments .giscus,
    #comments .giscus-frame {
      width: 100% !important;
      max-width: 100% !important;
    }

    @media (max-width: 768px) {
      body {
        padding: 10px;
      }

      .container {
        padding: 20px 15px;
        border-width: 1px;
      }

      h1 {
        font-size: 1.5em;
        letter-spacing: 2px;
        padding-bottom: 15px;
      }

      .subtitle {
        font-size: 1em;
        margin-bottom: 20px;
      }

      .notice {
        padding: 12px 15px;
        font-size: 0.9em;
      }

      .notice-title {
        font-size: 1em;
      }

      .school-row, .datetime-row {
        grid-template-columns: 1fr;
        gap: 10px;
      }

      input, select, textarea {
        padding: 10px;
        font-size: 0.95em;
      }

      button {
        padding: 12px;
        font-size: 1em;
        letter-spacing: 1px;
      }

      .tip {
        font-size: 0.85em;
        padding: 10px 12px;
      }

      .match-card {
        padding: 15px;
      }

      .match-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 10px;
      }

      .match-distance {
        align-self: flex-start;
      }

      .match-info {
        font-size: 0.95em;
      }

      .donate-section {
        padding: 20px 15px;
        margin-top: 30px;
      }

      .donate-title {
        font-size: 1.4em;
        margin-bottom: 15px;
      }

      .donate-desc {
        font-size: 0.9em;
        margin-bottom: 20px;
      }

      .qr-container {
        flex-direction: column;
        gap: 15px;
        align-items: center;
      }

      .qr-button {
        font-size: 1em;
        padding: 10px 25px;
      }

      .qr-image-wrapper {
        width: 220px;
        height: 220px;
      }

      .qr-popup {
        bottom: auto;
        top: calc(100% + 15px);
        left: 50%;
        transform: translateX(-50%);
      }

      .qr-item:hover .qr-popup {
        top: calc(100% + 20px);
        bottom: auto;
      }

      .qr-popup-inner::after {
        bottom: auto;
        top: -10px;
        border-top: none;
        border-bottom: 10px solid #c9a66b;
      }

      .footer {
        margin-top: 30px;
        padding-top: 20px;
        font-size: 0.85em;
      }

      .stats {
        flex-direction: column;
        gap: 8px;
      }

      .links {
        display: flex;
        flex-direction: column;
        gap: 10px;
      }

      .links a {
        margin: 0;
        display: block;
      }

      .suggestions {
        max-height: 150px;
        font-size: 0.9em;
      }

      .suggestion-item {
        padding: 10px;
      }
    }

    @media (max-width: 480px) {
      h1 {
        font-size: 1.3em;
        letter-spacing: 1px;
      }

      .container {
        padding: 15px 10px;
      }

      .notice {
        font-size: 0.85em;
      }

      input, select, textarea, button {
        font-size: 0.9em;
      }

      .match-name {
        font-size: 1.1em;
      }

      .donate-title {
        font-size: 1.2em;
      }

      .qr-button {
        font-size: 0.95em;
        padding: 10px 20px;
      }

      .qr-image-wrapper {
        width: 180px;
        height: 180px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>西安大学生拼车平台</h1>
    <p class="subtitle">同路同行，共享出行</p>

    <div class="notice">
      <div class="notice-title">平台说明</div>
      <p>本平台为西安地区大学生提供免费拼车信息匹配服务，帮助同学们找到同路出行的伙伴，降低出行成本。</p>
      <p style="margin-top: 8px;"><strong>数据保留政策：</strong>行程信息仅保留未来7天（从行程当天起算），7天后数据将自动清理。请勿录入7天后的行程，系统将自动拒绝。</p>
      <p style="margin-top: 8px;"><strong>隐私提示：</strong>只有发布行程的用户才能查看其他人的联系方式，仅查询不会显示联系方式。</p>
      <p style="margin-top: 8px;"><strong>匹配规则：</strong></p>
      <ul style="margin-left: 20px; margin-top: 5px;">
        <li>出发时间在您设定的时间范围内（±30分钟或±1小时）</li>
        <li>目的地距离您的目的地≤1公里</li>
        <li>最多显示2个匹配结果</li>
      </ul>
    </div>

    <div class="tabs">
      <button type="button" class="tab active" onclick="switchTab('publish')">发布行程</button>
      <button type="button" class="tab" onclick="switchTab('queryTime')">按时间查询</button>
      <button type="button" class="tab" onclick="switchTab('queryRoute')">按路线查询</button>
    </div>

    <div id="publishTab" class="tab-content active">
      <form id="tripForm">
      <div class="form-group">
        <label for="name">姓名 *</label>
        <input type="text" id="name" required placeholder="请输入您的姓名">
      </div>

      <div class="form-group">
        <label>学校 & 校区 *</label>
        <div class="school-row">
          <div style="position: relative;">
            <input type="text" id="school" required placeholder="请选择或输入学校" autocomplete="off">
            <div id="schoolSuggestions" class="suggestions" style="display: none;"></div>
          </div>
          <input type="text" id="campus" placeholder="所在校区（如：长安校区）">
        </div>
      </div>

      <div class="form-group">
        <label for="college">学院（可选）</label>
        <input type="text" id="college" placeholder="请输入学院名称">
      </div>

      <div class="form-group">
        <label>出发时间 *</label>
        <div class="datetime-row">
          <input type="date" id="departureDate" required>
          <input type="time" id="departureTime" required>
        </div>
      </div>

      <div class="form-group">
        <label for="timeRange">可接受的出发时间范围 *</label>
        <select id="timeRange" required>
          <option value="30">前后30分钟内（推荐，匹配更精确）</option>
          <option value="60">前后1小时内（匹配范围更广）</option>
        </select>
        <small style="color: #666; display: block; margin-top: 5px;">
          例如：您选择14:00出发，选择"前后30分钟"，则会匹配13:30-14:30之间出发的行程
        </small>
      </div>

      <div class="form-group">
        <label for="location">目的地 *</label>
        <div style="position: relative;">
          <input type="text" id="location" required placeholder="请输入目的地（支持地址搜索）" autocomplete="off">
          <div id="locationSuggestions" class="suggestions" style="display: none;"></div>
        </div>
      </div>

      <div class="form-group">
        <label for="contact">联系方式 *</label>
        <input type="text" id="contact" required placeholder="手机号（建议开通微信号查找功能）">
      </div>

      <div class="tip">
        提示：匹配成功后建议优先电话联系，并开通"可通过手机号查找微信"功能方便添加。
      </div>

      <button type="submit">发布行程并查找拼车</button>
      </form>

      <div id="loading" class="loading">
        <p>正在匹配拼车信息...</p>
      </div>

      <div id="message"></div>

      <div id="matches" class="matches"></div>
    </div>

    <div id="queryTimeTab" class="tab-content">
      <form id="timeQueryForm">
        <div class="form-group">
          <label for="queryDate">查询日期 *</label>
          <input type="date" id="queryDate" required>
        </div>

        <div class="form-group">
          <label>时间范围 *</label>
          <div class="datetime-row">
            <input type="time" id="queryStartTime" required placeholder="开始时间">
            <input type="time" id="queryEndTime" required placeholder="结束时间">
          </div>
        </div>

        <button type="submit">查询该时段行程</button>
      </form>

      <div id="timeQueryResult"></div>
    </div>

    <div id="queryRouteTab" class="tab-content">
      <form id="routeQueryForm">
        <div class="form-group">
          <label for="routeStart">出发地点（可选）</label>
          <input type="text" id="routeStart" placeholder="例如：西工大长安校区">
        </div>

        <div class="form-group">
          <label for="routeEnd">目的地 *</label>
          <input type="text" id="routeEnd" required placeholder="例如：航天城地铁站">
        </div>

        <div class="form-group">
          <label for="routeDate">指定日期（可选）</label>
          <input type="date" id="routeDate">
        </div>

        <button type="submit">查询该路线统计</button>
      </form>

      <div id="routeQueryResult"></div>
    </div>

    <div class="donate-section">
      <h2 class="donate-title">支持平台运营</h2>
      <div class="donate-desc">
        <p>本平台为公益性质的免费服务，运营费用包括 Cloudflare 服务器费用和高德地图 API 调用费用。</p>
        <p style="margin-top: 10px;">如果您觉得平台对您有帮助，欢迎通过以下方式支持我们：</p>
      </div>
      <div class="qr-container">
        <div class="qr-item">
          <button class="qr-button">微信赞赏</button>
          <div class="qr-popup">
            <div class="qr-popup-inner">
              <div class="qr-popup-label">微信扫码赞赏</div>
              <div class="qr-image-wrapper">
                <img src="https://dd.snnuisdc.workers.dev/images/wechhat.jpg" alt="微信赞赏码" class="qr-image">
              </div>
            </div>
          </div>
        </div>
        <div class="qr-item">
          <button class="qr-button">支付宝赞赏</button>
          <div class="qr-popup">
            <div class="qr-popup-inner">
              <div class="qr-popup-label">支付宝扫码赞赏</div>
              <div class="qr-image-wrapper">
                <img src="https://dd.snnuisdc.workers.dev/images/alipay.jpg" alt="支付宝赞赏码" class="qr-image">
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div id="comments" style="margin-top: 50px;"></div>

    <div class="footer">
      <div class="stats">
        <span class="stat-item">访客数：<span id="busuanzi_value_site_uv">--</span></span>
      </div>
      <div class="links">
        <a href="stats.html">访客统计</a>
        <a href="https://url.hxorz.cn" target="_blank">开发者工具代理加速</a>
        <a href="https://game.hxorz.cn" target="_blank">休闲小游戏</a>
      </div>
      <p style="margin-top: 20px;">© 2025 西安大学生拼车平台 · 让出行更便捷</p>
      <p class="runtime">
        <span class="heart">❤</span>
        本站已坚强运行 <span id="runDays">0</span> 天 <span id="runHours">0</span> 时 <span id="runMinutes">0</span> 分 <span id="runSeconds">0</span> 秒
      </p>
      <p style="margin-top: 10px;">By <a href="https://hxorz.cn" target="_blank" style="color: #8b4513; text-decoration: none;">hxorz</a></p>
    </div>
  </div>

  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
  <script src="https://giscus.app/client.js"
        data-repo="inwpu/dd"
        data-repo-id="R_kgDOQgDKSg"
        data-category="General"
        data-category-id="DIC_kwDOQgDKSs4CzOr6"
        data-mapping="pathname"
        data-strict="0"
        data-reactions-enabled="1"
        data-emit-metadata="0"
        data-input-position="bottom"
        data-theme="preferred_color_scheme"
        data-lang="zh-CN"
        crossorigin="anonymous"
        async>
  </script>

  <script>
    const API_BASE = 'https://dd.snnuisdc.workers.dev'; // Worker URL，部署后填写
    const SITE_START_DATE = '2025-12-01 00:00:00'; // 网站开始运行日期，请自行修改

    let currentTripId = null; // 保存用户发布的行程ID

    // 网站运行时间计算
    function updateRuntime() {
      const startDate = new Date(SITE_START_DATE);
      const now = new Date();
      const diff = now - startDate;

      const days = Math.floor(diff / (1000 * 60 * 60 * 24));
      const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
      const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
      const seconds = Math.floor((diff % (1000 * 60)) / 1000);

      document.getElementById('runDays').textContent = days;
      document.getElementById('runHours').textContent = hours;
      document.getElementById('runMinutes').textContent = minutes;
      document.getElementById('runSeconds').textContent = seconds;
    }

    // 每秒更新一次
    updateRuntime();
    setInterval(updateRuntime, 1000);

    // 标签页切换
    function switchTab(tabName) {
      // 隐藏所有标签内容
      document.querySelectorAll('.tab-content').forEach(tab => {
        tab.classList.remove('active');
      });
      document.querySelectorAll('.tab').forEach(tab => {
        tab.classList.remove('active');
      });

      // 显示选中的标签
      if (tabName === 'publish') {
        document.getElementById('publishTab').classList.add('active');
        document.querySelector('.tab:nth-child(1)').classList.add('active');
      } else if (tabName === 'queryTime') {
        document.getElementById('queryTimeTab').classList.add('active');
        document.querySelector('.tab:nth-child(2)').classList.add('active');
      } else if (tabName === 'queryRoute') {
        document.getElementById('queryRouteTab').classList.add('active');
        document.querySelector('.tab:nth-child(3)').classList.add('active');
      }
    }

    const SCHOOLS = [
      "西北工业大学",
      "西安交通大学",
      "西安电子科技大学",
      "长安大学",
      "陕西师范大学",
      "西北大学",
      "西安建筑科技大学",
      "西安理工大学",
      "西安科技大学",
      "西安工业大学",
      "西安外国语大学",
      "西安石油大学",
      "西安工程大学",
      "西安邮电大学",
      "西安医学院",
      "西安财经大学",
      "西北政法大学",
      "西安体育学院",
      "西安音乐学院",
      "西安美术学院",
      "西安文理学院",
      "西安航空学院",
      "西安培华学院",
      "西安思源学院",
      "西安翻译学院",
      "西京学院",
      "西安欧亚学院",
      "西安外事学院",
      "西安交通工程学院",
      "西安信息职业大学",
      "西安交通职业大学"
    ];

    let selectedLocation = null;
    let debounceTimer = null;

    // 学校输入提示
    const schoolInput = document.getElementById('school');
    const schoolSuggestions = document.getElementById('schoolSuggestions');

    schoolInput.addEventListener('input', (e) => {
      const value = e.target.value.trim();
      if (!value) {
        schoolSuggestions.style.display = 'none';
        return;
      }

      const matches = SCHOOLS.filter(school => school.includes(value));
      if (matches.length > 0) {
        schoolSuggestions.innerHTML = matches.map(school =>
          `<div class="suggestion-item" onclick="selectSchool('${school}')">${school}</div>`
        ).join('');
        schoolSuggestions.style.display = 'block';
      } else {
        schoolSuggestions.style.display = 'none';
      }
    });

    function selectSchool(school) {
      schoolInput.value = school;
      schoolSuggestions.style.display = 'none';
    }

    // 地点搜索
    const locationInput = document.getElementById('location');
    const locationSuggestions = document.getElementById('locationSuggestions');

    locationInput.addEventListener('input', (e) => {
      clearTimeout(debounceTimer);
      const value = e.target.value.trim();

      if (!value) {
        locationSuggestions.style.display = 'none';
        return;
      }

      debounceTimer = setTimeout(async () => {
        try {
          const response = await fetch(`${API_BASE}/api/search?keywords=${encodeURIComponent(value)}`);
          const data = await response.json();

          if (data.tips && data.tips.length > 0) {
            locationSuggestions.innerHTML = data.tips.map(tip =>
              `<div class="suggestion-item" onclick='selectLocation(${JSON.stringify(tip)})'>${tip.name}<br><small style="color:#888">${tip.district || ''} ${tip.address || ''}</small></div>`
            ).join('');
            locationSuggestions.style.display = 'block';
          } else {
            locationSuggestions.style.display = 'none';
          }
        } catch (error) {
          console.error('搜索失败:', error);
        }
      }, 400);
    });

    async function selectLocation(tip) {
      locationInput.value = tip.name;
      locationSuggestions.style.display = 'none';

      if (tip.location) {
        const [lon, lat] = tip.location.split(',');
        selectedLocation = { lat: parseFloat(lat), lon: parseFloat(lon), name: tip.name };
      } else {
        // 需要进一步解析
        try {
          const response = await fetch(`${API_BASE}/api/resolve-poi`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ name: tip.name })
          });
          const data = await response.json();

          if (data.pois && data.pois.length > 0) {
            const poi = data.pois[0];
            const [lon, lat] = poi.location.split(',');
            selectedLocation = { lat: parseFloat(lat), lon: parseFloat(lon), name: poi.name };
          }
        } catch (error) {
          console.error('解析位置失败:', error);
        }
      }
    }

    // 关闭建议框
    document.addEventListener('click', (e) => {
      if (!e.target.closest('#school') && !e.target.closest('#schoolSuggestions')) {
        schoolSuggestions.style.display = 'none';
      }
      if (!e.target.closest('#location') && !e.target.closest('#locationSuggestions')) {
        locationSuggestions.style.display = 'none';
      }
    });

    // 设置最小日期为今天
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('departureDate').min = today;

    // 表单提交
    document.getElementById('tripForm').addEventListener('submit', async (e) => {
      e.preventDefault();

      if (!selectedLocation) {
        showMessage('请选择有效的目的地', 'error');
        return;
      }

      const formData = {
        name: document.getElementById('name').value.trim(),
        school: document.getElementById('school').value.trim(),
        campus: document.getElementById('campus').value.trim(),
        college: document.getElementById('college').value.trim(),
        lat: selectedLocation.lat,
        lon: selectedLocation.lon,
        location_name: selectedLocation.name,
        departure_date: document.getElementById('departureDate').value,
        departure_time: document.getElementById('departureTime').value,
        contact: document.getElementById('contact').value.trim(),
        time_range: parseInt(document.getElementById('timeRange').value)
      };

      document.getElementById('loading').style.display = 'block';
      document.getElementById('matches').innerHTML = '';

      try {
        // 创建行程
        const createResponse = await fetch(`${API_BASE}/api/create-trip`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(formData)
        });

        const createResult = await createResponse.json();

        if (!createResponse.ok) {
          showMessage(createResult.error || '发布失败', 'error');
          document.getElementById('loading').style.display = 'none';
          return;
        }

        // 保存行程ID
        currentTripId = createResult.id;
        showMessage('行程发布成功！正在为您匹配拼车信息...', 'success');

        // 匹配行程（使用trip_id）
        const departureDateTime = new Date(`${formData.departure_date}T${formData.departure_time}:00`);
        const matchResponse = await fetch(`${API_BASE}/api/match`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            trip_id: currentTripId,
            lat: formData.lat,
            lon: formData.lon,
            departure_timestamp: departureDateTime.getTime()
          })
        });

        const matchResult = await matchResponse.json();

        if (!matchResponse.ok) {
          showMessage(matchResult.error || '匹配失败', 'error');
          document.getElementById('loading').style.display = 'none';
          return;
        }

        displayMatches(matchResult.matches || [], matchResult.your_trip);

      } catch (error) {
        console.error('提交失败:', error);
        showMessage('网络错误，请稍后重试', 'error');
      } finally {
        document.getElementById('loading').style.display = 'none';
      }
    });

    function displayMatches(matches, yourTrip) {
      const container = document.getElementById('matches');

      if (matches.length === 0) {
        container.innerHTML = `
          <div class="tip">
            暂无匹配的拼车信息，您的行程已发布，其他用户可以找到您！
            ${yourTrip ? `<p style="margin-top: 10px;">您的行程：${yourTrip.location} - ${yourTrip.time}</p>` : ''}
          </div>
        `;
        return;
      }

      container.innerHTML = `
        <h2 style="color: #8b4513; margin-bottom: 20px; border-bottom: 2px solid #c9a66b; padding-bottom: 10px;">
          找到 ${matches.length} 个可能的拼车伙伴
        </h2>
        ${matches.map(match => `
          <div class="match-card">
            <div class="match-header">
              <span class="match-name">${match.name}</span>
              <span class="match-distance">距离 ${match.distance} km</span>
            </div>
            <div class="match-info">
              <div>学校：${match.school} ${match.campus ? '· ' + match.campus : ''}</div>
              ${match.college ? `<div>学院：${match.college}</div>` : ''}
              <div>目的地：${match.location_name}</div>
              <div>出发时间：${match.departure_date} ${match.departure_time}</div>
            </div>
            <div class="match-contact">
              联系方式：${match.contact}
            </div>
          </div>
        `).join('')}
        <div class="tip">
          建议优先电话联系，并开通"可通过手机号查找微信"功能方便添加微信。
        </div>
      `;
    }

    function showMessage(message, type) {
      const messageDiv = document.getElementById('message');
      messageDiv.className = type;
      messageDiv.textContent = message;
      messageDiv.style.display = 'block';

      setTimeout(() => {
        messageDiv.style.display = 'none';
      }, 5000);
    }

    // 按时间查询
    document.getElementById('timeQueryForm').addEventListener('submit', async (e) => {
      e.preventDefault();

      const date = document.getElementById('queryDate').value;
      const startTime = document.getElementById('queryStartTime').value;
      const endTime = document.getElementById('queryEndTime').value;

      try {
        const response = await fetch(`${API_BASE}/api/search-by-time?date=${date}&start_time=${startTime}&end_time=${endTime}`);
        const data = await response.json();

        if (!response.ok) {
          showMessage(data.error || '查询失败', 'error');
          return;
        }

        displayTimeQueryResult(data);
      } catch (error) {
        console.error('查询失败:', error);
        showMessage('网络错误，请稍后重试', 'error');
      }
    });

    function displayTimeQueryResult(data) {
      const container = document.getElementById('timeQueryResult');

      if (data.total === 0) {
        container.innerHTML = '<div class="tip">该时段暂无行程信息</div>';
        return;
      }

      const schoolList = Object.entries(data.school_distribution)
        .map(([school, count]) => `<li>${school}: ${count} 人</li>`)
        .join('');

      container.innerHTML = `
        <div class="query-result">
          <h3 style="color: #8b4513; margin-bottom: 15px;">查询结果</h3>

          <div class="stat-grid">
            <div class="stat-box">
              <div class="stat-box-value">${data.total}</div>
              <div class="stat-box-label">总行程数</div>
            </div>
          </div>

          <div style="margin-top: 20px;">
            <h4 style="color: #8b4513; margin-bottom: 10px;">学校分布</h4>
            <ul style="line-height: 2; color: #5d4037;">
              ${schoolList}
            </ul>
          </div>

          <div style="margin-top: 20px;">
            <h4 style="color: #8b4513; margin-bottom: 10px;">行程列表（不含联系方式）</h4>
            ${data.trips.map(trip => `
              <div style="padding: 10px; background: white; margin-bottom: 8px; border-radius: 4px; border: 1px solid #e0d0b0;">
                <div><strong>${trip.school}</strong> ${trip.campus || ''}</div>
                <div>目的地：${trip.location}</div>
                <div>出发时间：${trip.departure_time}</div>
              </div>
            `).join('')}
          </div>

          <div class="tip" style="margin-top: 15px;">
            注意：此查询不显示联系方式。如需查看联系方式，请先发布您的行程。
          </div>
        </div>
      `;
    }

    // 按路线查询
    document.getElementById('routeQueryForm').addEventListener('submit', async (e) => {
      e.preventDefault();

      const startLocation = document.getElementById('routeStart').value.trim();
      const endLocation = document.getElementById('routeEnd').value.trim();
      const date = document.getElementById('routeDate').value;

      try {
        const response = await fetch(`${API_BASE}/api/search-by-route`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            start_location: startLocation || '任意地点',
            end_location: endLocation,
            date: date || null
          })
        });

        const data = await response.json();

        if (!response.ok) {
          showMessage(data.error || '查询失败', 'error');
          return;
        }

        displayRouteQueryResult(data);
      } catch (error) {
        console.error('查询失败:', error);
        showMessage('网络错误，请稍后重试', 'error');
      }
    });

    function displayRouteQueryResult(data) {
      const container = document.getElementById('routeQueryResult');

      if (data.total === 0) {
        container.innerHTML = '<div class="tip">该路线暂无行程信息</div>';
        return;
      }

      const timeSlots = Object.entries(data.time_distribution)
        .filter(([_, count]) => count > 0)
        .map(([time, count]) => `
          <div class="stat-box">
            <div class="stat-box-value">${count}</div>
            <div class="stat-box-label">${time}</div>
          </div>
        `).join('');

      container.innerHTML = `
        <div class="query-result">
          <h3 style="color: #8b4513; margin-bottom: 15px;">路线统计</h3>

          <div style="background: white; padding: 15px; border-radius: 6px; margin-bottom: 20px; border: 1px solid #c9a66b;">
            <div><strong>路线：</strong>${data.route.start} → ${data.route.end}</div>
            <div style="margin-top: 8px;"><strong>日期：</strong>${data.date}</div>
            <div style="margin-top: 8px; color: #8b4513; font-size: 1.1em;">${data.summary}</div>
          </div>

          <div class="stat-grid">
            ${timeSlots}
          </div>

          <div class="tip" style="margin-top: 15px;">
            注意：此查询仅显示统计信息，不显示联系方式。如需查看联系方式，请先发布您的行程。
          </div>
        </div>
      `;
    }

    // 设置查询表单的最小日期为今天
    document.getElementById('queryDate').min = new Date().toISOString().split('T')[0];
    document.getElementById('routeDate').min = new Date().toISOString().split('T')[0];
  </script>
</body>
</html>
